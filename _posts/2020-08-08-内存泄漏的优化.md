---
layout: post
title: '内存泄漏的优化'
date: 2020-08-08
author: qzhuorui
color: rgb(154,133,255)
tags: Android性能调优
---



# 内存泄漏的优化

> 内存泄漏本身并不会造成程序异常，但是随着量的增加会导致其他各种并发症：OOM，UI卡顿

## 一、Activity内存泄漏预防

Activity承担了与用户交互的责任，因此内部需要**持有大量的资源引用以及与系统交互的Context** ，这会导致一个Activity对象的retained size特别大。一旦Activity因为被外部系统所持有而导致内存泄漏，被牵连导致其他对象的内存泄漏也会非常多。

造成Activity内存泄漏的场景主要有一下几种：

### 1.将Context或View设置为static

View默认会持有一个Context的引用，如果将其置为static将会造成View在方法区中无法被快速回收，最终导致内存泄漏。` private static ImageView imageView ` 。imageView会造成所在类无法被GC回收。

### 2.未解注册各种listener

在Activity中可能会注册各种系统监听器，比如广播

### 3.非静态Handler导致Activity泄漏

```
private Handler handler = new Handler(){
	@Override
    public void handlerMessage(Message msg){
        super.handleMesage(msg);
    }
};
```

上述代码中的Handler也会造成此Activity内存泄漏，一般需要将其置为static，然后内部持有一个Activity的弱引用来避免内存泄漏。

### 4.第三方库使用Context

经常使用第三方库时，有些库的初始化需要传入一个Context对象。但是第三方库中有可能一直持有此Context引用。如：三方库中将传入的context重新置为一个static类型。这种很难察觉，平时**使用尽量使用Context.getApplicationContext，不要直接将Activity传递给其他组件** 。在自己实现SDK时，可以使用context.getApplicationContext，即使外部传入是Activity，也不会造成内存泄漏`context.getApplication();`

## 二、内存泄漏检测

可以使用AndroidStudio查看Activity是否存在内存泄漏，并结合MAT来查看发生内存泄露的对象。这个今后和Android性能调优放一起学习。

除了AS之外，还有一个工具就是LeakCanary，这是一个开源库。通过它可以在APP运行时检测内存泄漏，当内存泄漏时会发生泄露对象的引用链，并通知程序开发人员。

可以看到LeakCanary主要分2大核心部分：

1. 如何检测内存泄漏
2. 分析内存泄漏对象的引用链



### 1.如何检测内存泄漏

#### JVM理论知识



