---
layout: post
title: 'qzhuorui'
date: 2020-08-03
author: qzhuorui
color: rgb(255,210,32)
tags: 并发
---



# 偏向锁，轻量级锁，重量级锁

Java的线程是映射到操作系统原生线程之上的，如果需要**阻塞或唤醒一个线程** 就需要操作系统的帮忙，这就要从**用户态转换到核心态** ，状态转换需要花费很多的处理器时间。

```
private Object lock = new Object();
private int value;

public void setValue(){
    sync(this){
        value++;
    }
}
```

value++因为被关键字sync修饰，所以会在各个线程间同步执行。但是value++消耗的时间很有可能**比线程状态转换消耗的时间还短** ，所以说**sync** 是Java中一个**重量级操作** 。

## 一、sync实现原理

要了解sync的原理，需要先理清楚两件事：1.对象头 2.Monitor

### 1.对象头

**Java对象** 在内存中的布局分为3部分：

1. 对象头
2. 实例数据
3. 对齐填充

当我们在Java代码中，使用new创建一个对象时，JVM会在**堆中** 创建一个**instanceOopDesc对象** ，这个对象中包含了对象头和实例数据。

instanceOopDesc的基类为oopDesc类，主要结构：

```
volatile markOop _mark;
union _meradata {
    wideKlassOop _klass;
    narrowOop _compressed_klass;
} _metadata;
```

其中_mark和 _metadata一起组成了对象头。 _metadata主要保存了类元数据。重点看下 _mark属性， _mark是markOop类型数据，一般称他为标记字段（Mark Word），其中主要存储了对象的hasCode，分代年龄，锁标志位，是否偏向锁等。

