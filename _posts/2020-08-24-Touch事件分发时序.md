---
layout: post
title: 'Touch事件分发时序'
date: 2020-08-24
author: qzhuorui
color: rgb(154,133,255)
tags: Android
---



> 学习Android Touch事件分发时序

# Android Touch事件分发时序

关于事件分发主要有3个方向可以展开深入分析：

1. touch事件是如何从驱动层传递给Framework层的InputManagerService
2. WMS是如何通过ViewRootImpl将事件传递到目标窗口
3. touch事件到达ViewRootImpl后，是如何一步步传递到内部的子View中的

其中与上层开发相关的就是第3条，也是本次总结学习的重点内容，基于Android-28源码阅读学习

## 思路梳理，基本概念

首先需要弄清楚2个概念

### 1.ViewGroup

ViewGroup是一组View的组合，在其内部有可能包含多个子View，当手指触摸屏幕上时手指所在的区域既能在ViewGroup显示范围内，也可能在其内部View控件上

因此它内部的事件分发的**重心是处理当前Group和子View之间的逻辑关系： **

1. 当前Group是否需要拦截touch事件
2. 是否需要将touch事件继续分发给子View
3. 如何将touch事件分发给子View

### 2.View

View是一个单纯的控件， **不能再被细分** ，内部也并不会存在子View，所以它的事件分发的**重点在于当前View如何去处理touch事件** ，并根据相应的手势逻辑进行一系列的效果展示（比如滑动，放大，点击，长按）

1. 是否存在TouchListener
2. 是否自己接收处理touch事件（主要逻辑在onTouchEvent方法中）

## 事件分发核心dispatchTouchEvent

整个View之间的事件分发， **实质上就是一个大的递归函数** ，而这个递归函数就是dispatchTouchEvent方法。在这个**递归的过程中会适时调用onInterceptTouchEvent来拦截事件，或调用onTouchEvent方法来处理事件**

先从宏观角度，纵览整个dispatch的源码：

![1](/screenshot/Touch事件分发时序/1.png)

如注释所言，dispatch主要分为3大步骤：

1. 判断当前ViewGroup是否需要拦截此touch事件，如果拦截则此touch事件不会再传递给子View（或以CANCEL方式通知子View）
2. 如果没有拦截，则将事件分发给子View继续处理，如果子View将此次事件捕获，则将mFirstTouchTarget赋值给捕获touch事件的View
3. 根据mFirstTouchTarget重新分发事件

接下来具体看下各个步骤细节

### 1.判断当前ViewGroup是否需要拦截此touch事件

![2](/screenshot/Touch事件分发时序/2.png)

红框标出了是否需要拦截的条件：

1. 如果事件为DOWN事件，则调用onInterceptTouchEvent进行拦截判断
2. 或者mFirstTouchTarget !=null，代表已经有子View捕获了这个事件，子View的dispatchTouchEvent返回true就是代表捕获touch事件

如果在1中，当前ViewGroup并没有对事件进行拦截，则执行步骤2

### 2.将事件分发给子View

![3](/screenshot/Touch事件分发时序/3.png)

1. ①处表明事件主动分发的前提是事件为DOWN事件
2. ②遍历所有子View
3. ③判断事件坐标是否在子View坐标范围内，并且子View并没有处在动画状态
4. ④调用dispatchTransformTouchEvent方法将事件分发给子View，如果子View捕获事件成功，则将mFirstTouchTarget赋值给子View

### 3.根据mFirstTouchTarget再次分发事件

![4](/screenshot/Touch事件分发时序/4.png)

步骤3有2个分支判断：

1. 分支1：如果此时mFirstTouchTarget为null，说明在上述的事件分发中并没有子View对事件进行了捕获操作。这种情况下，直接调用dispatchTransformTouchEvent方法，并传入child为null，最终会调用super.dispatchTouchEvent方法。实际上最终会调用自身的onTouchEvent方法，进行处理touch事件。也就是说： **如果没有子View捕获处理touch事件，ViewGroup会通过自身的onTouchEvent方法进行处理**
2. 分支2：mFirstTouchTarget !=null，说明在上面步骤2中有子View对touch事件进行了捕获，则直接将当前以及后续的事件交给mFirstTouchTarget指向的View进行处理

## 事件分发流程代码演示





























